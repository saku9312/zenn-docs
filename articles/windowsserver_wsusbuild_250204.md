---
title: "WindowsServerでのWSUSサーバー設定"
emoji: "🎉"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: true
---
## WSUSの有効化と構成
そのうちなくなる予定のローカルWSUSだが、機能として触ったことがないのはまずいと感じて構築を始める。
なくなる予定なのにWindowsServerの2025にも有効にできるんだ…。

## WSUSの有効化
（事前準備）
どこかにWSUSの更新プログラムを保存するディレクトリを作成（今回はC:\WSUS）

1. 管理→「役割と機能の追加」をクリック
2. 役割と機能の追加ウィザードで「役割ベースまたは機能ベースのインストール」を選択
3. サーバーを選択し進める
4. サーバーの役割の選択で「Windows Server Update Service」を選択
5. いくつか選択されるので、そのまま「機能の追加」をクリック
6. サーバーの役割の選択も、特に触らず進める
7. Webサーバーの役割（IIS）もそのまま進める
8. 役割サービスの選択もそのまま
9. Windows Server Update Service も次へ出進める
10. 役割サービスの選択は、「WID Connectivity」と「WSUS Service」を選択
11. 更新プログラムの保存先（C:\WSUS）を入力
12. インストールオプションの確認で内容を確認、インストールを実施

## 設定ウィザードの構成
1. 品質向上プログラムに参加するかどうか進める
2. アップストリームサーバーの選択だが、今回はプライマリなので「Microsoft Updateから同期する」を選択
3. プロキシサーバーの設定画面に進むので、プロキシサーバーがあればここに設定
4. アップストリームサーバーへ接続する、「接続の開始」をクリック
5. 言語の選択は、「日本語」「英語」を選択
6. プログラムの選択画面になるが、必要なものだけ選択すること！！ 容量が逼迫するため。
7. 最後に自動同期を開始するかを選択して、完了

## グループポリシーを利用したWSUSの適用
1. OUを作成し、ドメインに入っているPCを移動させる
2. グループポリシーを作成し、以下の項目を設定

    ### ・[イントラネットのMicrosoft更新サービスの場所を指定する]
       ◎[コンピューターの構成]＞[管理用テンプレート]＞[Windowsコンポーネント]＞[Windows Update]＞[Windows Server Update Serviceから提供される更新プログラムの管理]
       ◎有効にする
       ◎オプション：イントラネットの更新サービスを設定する→http://＜IPアドレス＞:8530
       ◎オプション：イントラネット統計サーバーの設定→http://＜IPアドレス＞:8530

   ### ・[自動更新を構成する]
       ◎[コンピューターの構成]＞[管理用テンプレート]＞[Windowsコンポーネント]＞[Windows Update]＞[エンドユーザーエクスペリエンスの管理]
       ◎有効にする
       ◎自動更新の構成：自由だが、今回は4-自動ダウンロードしインストール日時を指定
       ◎0-毎日、03:00としている
3. 画面更新を行い、ポリシーが登録されていることを確認


## ポリシーが反映できずエラーが発生する場合
### グループポリシーの強制更新時のエラー「グループポリシーの処理に失敗しました」
あるあるだから、改めてまとめ。
グループポリシーの変更後、クライアント側で以下のコマンドを実施した際、

    gpupdate /force
    ドメインコントローラーへのネットワークが接続が存在しないため、グループポリシーの処理に失敗しました。

と表示されることがある。

### 確認事項
まずは、適用状況を確認してエラーが起きていないかを確認する。

    gpresult /f /H %userprofile%\GPResult.html

HTMLファイルを開き、エラーを確認する。
タイムアウトしました。などのエラーであればドメインの再参加で解決できる。

### 対応策
ドメインから一旦WORKGROUPに外し、再度ドメインに参加させる。
タイムアウトが原因の場合は、レジストリに以下の内容を設定することで改善することがある。

レジストリ サブキー: HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Netlogon\Parameters
値の名前: ExpectedDialupDelay
データ型: REG_DWORD
データ値が秒単位 (既定値 = 0)
データ範囲は 0 ~ 600 秒 (10 分) 

https://learn.microsoft.com/ja-jp/troubleshoot/windows-server/group-policy/netlogon-event-id-5719-or-group-policy-event-1129

今回は、ドメインの再参加で解決している。
